// controllers/denverLiveOccupancyController.js

exports.getDenverSnapshotAt = async (req, res) => {
  try {
    const atRaw = req.query.at;
    if (!atRaw) {
      return res.status(400).json({
        error: 'missing "at" query parameter (expected ISO date-time string)'
      });
    }

    // Parse with Luxon in Denver timezone
    const atDt = DateTime.fromISO(atRaw, { zone: 'America/Denver' });
    if (!atDt.isValid) {
      return res.status(400).json({ error: 'invalid "at" timestamp' });
    }

    const untilJsDate = atDt.toJSDate();

    // fetch 24h window ending at this instant
    const events = await fetchEventsWindowUntil(untilJsDate);

    // Build occupancy payload
    const payload = buildOccupancyForToday(events, []);

    // Override asOf with requested instant
    payload.asOf = atDt.toUTC().toISO();

    return res.json(payload);
  } catch (err) {
    console.error('getDenverSnapshotAt error:', err);
    return res.status(500).json({ error: 'Internal Server Error' });
  }
};






...




GET /api/occupancy-at-denver?at=2025-09-13T14:30:00


