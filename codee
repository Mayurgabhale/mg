const iso = new Date(`${local}:00`).toISOString();
onApply(iso);
...


{timeTravelMode && (
  <div style={{
    background: '#3b403e',
    color: '#FFF',
    padding: '8px 16px',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderLeft: '4px solid #00ff40',
    marginBottom: 8
  }}>
    <div>
      Viewing historical snapshot for:&nbsp;
      <strong>
        {timeTravelTimestamp
          ? (new Date(timeTravelTimestamp)).toLocaleString('en-GB', {
              timeZone: 'Asia/Kolkata',
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', hour12: true
            }) + ' (IST)'
          : ''}
      </strong>
    </div>
    <div>
      <button className="btn btn-sm btn-outline-warning" onClick={() => clearTimeTravel()} disabled={timeTravelLoading}>
        Return to Live
      </button>
    </div>
  </div>
)}






....

// Handler: GET /api/occupancy-at?{timeTravelMode && (
  <div style={{
    background: '#3b403e',
    color: '#FFF',
    padding: '8px 16px',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderLeft: '4px solid #00ff40',
    marginBottom: 8
  }}>
    <div>
      Viewing historical snapshot for:&nbsp;
      <strong>
        {timeTravelTimestamp
          ? (new Date(timeTravelTimestamp)).toLocaleString('en-GB', {
              timeZone: 'Asia/Kolkata',
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', hour12: true
            }) + ' (IST)'
          : ''}
      </strong>
    </div>
    <div>
      <button className="btn btn-sm btn-outline-warning" onClick={() => clearTimeTravel()} disabled={timeTravelLoading}>
        Return to Live
      </button>
    </div>
  </div>
)}at=<ISO-8601>
exports.getSnapshotAt = async (req, res) => {
  try {
    const atRaw = req.query.at;
    if (!atRaw) return res.status(400).json({ error: 'missing "at" query parameter (ISO timestamp required)' });

    const atDate = new Date(atRaw);
    if (Number.isNaN(atDate.getTime())) {
      return res.status(400).json({ error: 'invalid "at" timestamp' });
    }

    // Treat the incoming `at` as a UTC instant (this is what frontend sends).
    // Convert that instant into the local calendar date in Asia/Kolkata.
    const asOfLocalDate = DateTime.fromJSDate(atDate, { zone: 'utc' })
      .setZone('Asia/Kolkata')
      .toFormat('yyyy-LL-dd');

    // Fetch events in the 24h window ending at atDate (same as before)
    const events = await fetchEventsWindow(atDate);

    // Keep only events whose Dateonly (SQL) equals the requested Asia/Kolkata calendar date
    const filteredEvents = events.filter(evt => String(evt.Dateonly) === asOfLocalDate);

    // Build occupancy and visited stats from the filtered events only
    const occupancy = await buildOccupancy(filteredEvents);
    const visitedStats = buildVisitedForDate(filteredEvents, atDate);

    occupancy.totalVisitedToday = visitedStats.total;
    occupancy.visitedToday = {
      employees: visitedStats.employees,
      contractors: visitedStats.contractors,
      total: visitedStats.total
    };

    // Return `asOf` as the client-requested UTC instant (so frontend still gets what it asked)
    occupancy.asOf = atDate.toISOString();

    return res.json(occupancy);
  } catch (err) {
    console.error('getSnapshotAt error:', err);
    return res.status(500).json({ error: 'Internal Server Error' });
  }
};