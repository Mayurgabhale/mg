function buildVisitedForDate(allEvents, atDate) {
  // Get the local day of "atDate" in Asia/Kolkata
  const asOfLocalDate = DateTime.fromJSDate(atDate, { zone: 'utc' })
    .setZone('Asia/Kolkata')
    .toFormat('yyyy-LL-dd');

  // Keep only IN swipes for that local date,
  // but allow ANY time from 00:00 until atDate
  const todayIns = allEvents.filter(evt =>
    evt.Direction === 'InDirection' &&
    evt.Dateonly === asOfLocalDate &&
    evt.LocaleMessageTime <= atDate // NEW: don’t go past snapshot time
  );

  // Dedupe by PersonGUID → latest swipe wins
  const dedup = new Map();
  for (const e of todayIns) {
    const key = e.PersonGUID;
    const prev = dedup.get(key);
    if (!prev || e.LocaleMessageTime > prev.LocaleMessageTime) {
      dedup.set(key, e);
    }
  }

  const finalList = Array.from(dedup.values());

  const employees = finalList.filter(e =>
    !['Contractor','Terminated Contractor','Temp Badge','Visitor','Property Management']
      .includes(e.PersonnelType)
  ).length;
  const contractors = finalList.length - employees;

  return { employees, contractors, total: finalList.length };
}