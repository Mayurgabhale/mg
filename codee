// canonical company resolution: normalize & group common variants
const getCanonicalCompany = (r) => {
  // helper: normalize a string to lower-case, remove punctuation, collapse spaces
  const normalize = (s) => {
    if (!s) return '';
    return String(s)
      .toLowerCase()
      .normalize('NFKD')              // normalize diacritics
      .replace(/[\u0300-\u036f]/g, '')// strip accents
      .replace(/[^a-z0-9\s]/g, ' ')   // remove punctuation, keep letters/numbers/spaces
      .replace(/\s+/g, ' ')           // collapse multiple spaces
      .trim();
  };

  const raw = r.CompanyName && String(r.CompanyName).trim();
  const pt = (r.PersonnelType && String(r.PersonnelType).toLowerCase()) || '';

  // 1) If CompanyName exists, try to canonicalize it
  if (raw) {
    const n = normalize(raw);

    // ----- WU / Western Union family -> map to single canonical name -----
    // This catches forms like: "WU Srvcs India Private Ltd", "WU Paymnt Services Ireland Ltd-IRL",
    // "WU Processing Lithuania, UAB", "Western Union, LLC", "Western Union Morocco", "WU Retail Services", "WUI Bank GmbH", "WUPSIL", etc.
    if (
      n.includes('western union') ||
      n.startsWith('wu ') ||
      n.startsWith('wui') ||
      n.includes('wuprocessing') ||
      n.includes('wupay') ||
      n.includes('wu pay') ||
      n.includes('wups') ||
      n.includes('wupsm') ||
      n.includes('wu retail') ||
      n.includes('wu financial') ||
      n.includes('westernunion') ||
      n.includes('westernunionfin') ||
      n.includes('western union fin') ||
      n.includes('western union payment') ||
      n.includes('payment services') && n.includes('western')
    ) {
      return 'WU Srvcs India Private Ltd';
    }

    // ----- Addendum family -----
    if (n.includes('addendum')) {
      return 'Addendum Solutions';
    }

    // ----- G4S family -----
    if (n.includes('g4s')) {
      return 'G4S Secure Solutions';
    }

    // ----- UAB family (Lithuania / UAB prefix) -----
    // Map UAB-prefixed companies into a single UAB bucket (or you can make it more specific)
    if (n.startsWith('uab ') || n.includes(' uab ') || n.includes('uab')) {
      return 'UAB';
    }

    // ----- WUI / WUI Bank specifics already caught by WU logic above, but keep example mapping -----
    // if (n.includes('wui bank')) return 'WU Srvcs India Private Ltd';

    // ----- Some other catch-alls you might want grouped -----
    // If you want "Unknown" mapping for specific tokens:
    if (n === 'unknown' || n === '') return 'Unknown';

    // If none of the above matched, return the cleaned original (preserves vendor names)
    // But keep original capitalization from raw for display
    return raw;
  }

  // 2) No CompanyName: infer from PersonnelType (as before)
  if (pt.includes('temp')) return 'Temp Badge';
  if (pt.includes('visitor')) return 'Visitor';

  // fallback
  return 'Unknown';
};