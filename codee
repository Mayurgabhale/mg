function buildVisitedForDate(allEvents, atDate) {
  const asOfLocalDate = DateTime.fromJSDate(atDate, { zone: 'utc' })
    .setZone('Asia/Kolkata')
    .toFormat('yyyy-LL-dd');

  const todayIns = allEvents.filter(evt =>
    evt.Direction === 'InDirection' && evt.Dateonly === asOfLocalDate
  );

  // temp debugging: counts of missing identifiers
  const missing = todayIns.filter(
    e => !e.PersonGUID && !e.EmployeeID && !e.CardNumber
  ).length;
  console.log(
    'DEBUG visited: totalRows=',
    todayIns.length,
    'rowsMissingAllIds=',
    missing
  );

  const dedup = new Map();
  for (const e of todayIns) {
    const key = e.PersonGUID;
    const prev = dedup.get(key);
    if (!prev || e.LocaleMessageTime > prev.LocaleMessageTime) {
      dedup.set(key, e);
    }
  }
  // ...
}