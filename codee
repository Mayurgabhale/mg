
const result = await req.query(query);

return result.recordset.map(r => ({
  ...r,
  duration: r.DurationSeconds != null
    ? new Date(r.DurationSeconds * 1000).toISOString().substr(11, 8) // HH:mm:ss
    : null
}));




....


// 4. Final query
const query = `
    WITH Hist AS (
      ${unionQueries}
    ),
    Enriched AS (
      SELECT
        Hist.*,
        MIN(LocaleMessageTime) OVER (PARTITION BY PersonGUID) AS FirstSwipe,
        MAX(LocaleMessageTime) OVER (PARTITION BY PersonGUID) AS LastSwipe,
        DATEDIFF(SECOND,
          MIN(LocaleMessageTime) OVER (PARTITION BY PersonGUID),
          MAX(LocaleMessageTime) OVER (PARTITION BY PersonGUID)
        ) AS DurationSeconds
      FROM Hist
    )
    SELECT *
    FROM Enriched
    ${outerFilter}
    ORDER BY LocaleMessageTime ASC;
  `;


 const result = await req.query(query);
  return result.recordset;
