import React, { useState, useEffect, useMemo } from 'react'; import axios from 'axios'; import { toast } from 'react-toastify'; import 'react-toastify/dist/ReactToastify.css'; import { FiUpload, FiTrash2, FiDownload, FiGlobe, FiFilter, FiSearch, FiFileText, FiCheckCircle, FiXCircle, FiUser, FiMail, FiMapPin, FiCalendar, FiEye } from 'react-icons/fi'; import { FaPlane, FaCar, FaTrain, FaTruck, FaShip, FaBicycle, FaHotel, FaLocationArrow } from 'react-icons/fa'; import { BsPersonWalking } from 'react-icons/bs';

// initialize toast once toast.configure();

// Simple date formatting helper const fmt = (iso) => { if (!iso) return '—'; try { const d = new Date(iso); return d.toLocaleString(); } catch (e) { return iso; } };

// Basic inline styles generator (keeps component self-contained) const getStyles = (dark) => { const bg = dark ? '#0f172a' : '#ffffff'; const card = dark ? '#0b1220' : '#f8fafc'; const text = dark ? '#e6eef8' : '#0f172a'; return { page: { padding: 20, background: bg, minHeight: '100vh', color: text, fontFamily: 'Inter, sans-serif' }, card: { background: card, borderRadius: 10, padding: 16, boxShadow: '0 4px 10px rgba(0,0,0,0.03)', marginBottom: 16 }, compactUploadRow: { display: 'flex', gap: 8, alignItems: 'center' }, compactFileUpload: { display: 'flex', alignItems: 'center', gap: 8 }, fileInput: { display: 'none' }, compactFileLabel: { display: 'inline-flex', alignItems: 'center', gap: 8, padding: '8px 12px', borderRadius: 8, cursor: 'pointer', background: dark ? '#0b1220' : '#fff', border: '1px solid #e6eef8' }, compactPrimaryBtn: { padding: '8px 12px', borderRadius: 8, cursor: 'pointer', border: 'none', background: '#2563eb', color: '#fff' }, compactSecondaryBtn: { padding: '8px', borderRadius: 8, cursor: 'pointer', border: 'none', background: '#ef4444', color: '#fff' }, compactGhostBtn: { padding: '8px', borderRadius: 8, cursor: 'pointer', border: '1px solid #e6eef8', background: 'transparent' }, regionCardsSection: { marginTop: 12 }, regionCardsGrid: { display: 'flex', gap: 12, marginTop: 12, flexWrap: 'wrap' }, regionCard: { width: 200, padding: 12, borderRadius: 8, background: dark ? '#071029' : '#fff', boxShadow: '0 2px 6px rgba(0,0,0,0.03)' }, regionCardHeader: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }, regionIcon: { width: 36, height: 36, borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff' }, regionName: { fontWeight: 700 }, regionCount: { fontSize: 20, fontWeight: 700 }, regionLabel: { fontSize: 12, color: '#6b7280' }, activeDot: { width: 10, height: 10, borderRadius: 10, background: '#10b981', marginRight: 6 }, filtersSection: { marginTop: 12 }, filtersRow: { display: 'flex', gap: 8, marginTop: 8, alignItems: 'center' }, searchWrapper: { display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', borderRadius: 8, border: '1px solid #e6eef8', background: dark ? '#071029' : '#fff' }, searchInput: { border: 'none', outline: 'none', background: 'transparent' }, select: { padding: '8px 10px', borderRadius: 8, border: '1px solid #e6eef8', background: 'transparent' }, tableWrap: { overflowX: 'auto', marginTop: 12 }, table: { width: '100%', borderCollapse: 'collapse' }, th: { textAlign: 'left', padding: 8, fontSize: 13, color: '#6b7280' }, td: { padding: 10, fontSize: 13, borderTop: '1px solid #e6eef8' }, rowEven: { background: 'transparent' }, rowOdd: { background: dark ? '#071829' : '#fcfeff' }, activeBadge: { display: 'inline-flex', alignItems: 'center', gap: 6, background: '#ecfdf5', color: '#065f46', padding: '6px 8px', borderRadius: 6 }, inactiveBadge: { display: 'inline-flex', alignItems: 'center', gap: 6, background: '#fff1f2', color: '#991b1b', padding: '6px 8px', borderRadius: 6 }, viewButton: { padding: '8px 10px', borderRadius: 8, border: 'none', cursor: 'pointer', background: '#2563eb', color: '#fff' }, popupOverlay: { position: 'fixed', left: 0, top: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000 }, popupContent: { width: 720, maxHeight: '80vh', overflowY: 'auto', background: card, borderRadius: 10, padding: 16 }, popupHeader: { display: 'flex', gap: 12, alignItems: 'center', marginBottom: 12 }, avatarLarge: { width: 48, height: 48, borderRadius: 10, background: '#e6eef8', display: 'flex', alignItems: 'center', justifyContent: 'center' }, popupTitle: { margin: 0, fontSize: 18 }, dateCell: { display: 'flex', alignItems: 'center', gap: 8 } }; };

export default function EmployeeTravelDashboard() { // core states const [file, setFile] = useState(null); const [items, setItems] = useState([]); const [summary, setSummary] = useState({}); const [loading, setLoading] = useState(false); const [filters, setFilters] = useState({ country: '', location: '', legType: '', search: '', status: '' }); const [selectedTraveler, setSelectedTraveler] = useState(null); const [activeTab, setActiveTab] = useState('overview');

const [isDarkTheme, setIsDarkTheme] = useState(false); const toggleTheme = () => setIsDarkTheme(v => !v);

// monthly-related states const [employeeData, setEmployeeData] = useState([]); const [monthlyFile, setMonthlyFile] = useState(null); const [showUploadPopup, setShowUploadPopup] = useState(false); const [hasUploadedData, setHasUploadedData] = useState(false); const [uploadTime, setUploadTime] = useState(null); const [uploadStatus, setUploadStatus] = useState('');

// regions const [regionsData, setRegionsData] = useState({}); const [selectedRegion, setSelectedRegion] = useState(null); const [regionDetails, setRegionDetails] = useState(null);

useEffect(() => { const savedHasUploadedData = localStorage.getItem('hasUploadedData'); const savedUploadTime = localStorage.getItem('uploadTime'); const savedMonthlyFile = localStorage.getItem('monthlyFile');

if (savedHasUploadedData === 'true') {
  setHasUploadedData(true);
  if (savedUploadTime) setUploadTime(new Date(savedUploadTime));
  if (savedMonthlyFile) setMonthlyFile(JSON.parse(savedMonthlyFile));
  fetchEmployeeData();
}

}, []);

const fetchEmployeeData = async () => { try { const res = await axios.get('http://localhost:8000/monthly_sheet/employees'); const data = res.data || {}; setEmployeeData(data.employees || []); setUploadTime(data.uploaded_at ? new Date(data.uploaded_at) : null); setUploadStatus(data.message || ''); } catch (err) { console.error('Failed to fetch employee data:', err); } };

const handleMonthlyFileChange = (e) => { const selected = e.target.files?.[0]; setMonthlyFile(selected); };

const handleUploadSubmit = async () => { if (!monthlyFile) return toast.warn('Please choose a monthly employees file'); const formData = new FormData(); formData.append('file', monthlyFile); try { setUploadStatus('Uploading...'); const res = await axios.post('http://localhost:8000/monthly_sheet/upload_monthly', formData); if (res.status === 200) { setUploadStatus('Upload successful!'); setUploadTime(new Date()); setHasUploadedData(true); setShowUploadPopup(false); localStorage.setItem('hasUploadedData', 'true'); localStorage.setItem('uploadTime', new Date().toISOString()); localStorage.setItem('monthlyFile', JSON.stringify({ name: monthlyFile.name, size: monthlyFile.size })); await fetchEmployeeData(); toast.success('Monthly employee file uploaded'); } else { throw new Error('Upload failed'); } } catch (err) { console.error(err); setUploadStatus('Upload failed'); toast.error('Upload failed'); } };

const confirmDeleteData = () => { if (window.confirm('Are you sure you want to delete all employee data? This action cannot be undone.')) deleteEmployeeData(); };

const deleteEmployeeData = async () => { try { await axios.delete('http://localhost:8000/monthly_sheet/clear_data'); setEmployeeData([]); setMonthlyFile(null); setHasUploadedData(false); setUploadTime(null); setUploadStatus(''); localStorage.removeItem('hasUploadedData'); localStorage.removeItem('uploadTime'); localStorage.removeItem('monthlyFile'); toast.success('Employee data cleared successfully.'); } catch (err) { console.error(err); toast.error('Failed to clear data.'); } };

// add traveler form const [showAddForm, setShowAddForm] = useState(false); const [newTraveler, setNewTraveler] = useState({ first_name: '', last_name: '', emp_id: '', email: '', begin_dt: '', end_dt: '', from_location: '', from_country: '', to_location: '', to_country: '', leg_type: '' });

const addTraveler = async () => { try { await axios.post('http://localhost:8000/daily_sheet/add_traveler', newTraveler); toast.success('Traveler added successfully!'); setShowAddForm(false); setNewTraveler({ first_name: '', last_name: '', emp_id: '', email: '', begin_dt: '', end_dt: '', from_location: '', from_country: '', to_location: '', to_country: '', leg_type: '' }); const res = await axios.get('http://localhost:8000/daily_sheet/data'); const payload = res.data || {}; setItems(payload.items || []); setSummary(payload.summary || {}); } catch (err) { console.error(err); toast.error('Failed to add traveler. Check backend.'); } };

const styles = getStyles(isDarkTheme); const [lastUpdated, setLastUpdated] = useState(null);

// load previous data & auto-refresh useEffect(() => { const fetchLatest = async (showToast = false) => { try { const res = await axios.get('http://localhost:8000/daily_sheet/data'); const payload = res.data || {}; const rows = payload.items || []; if (rows.length > 0) { setItems(rows); setSummary(payload.summary || {}); if (showToast) toast.info(Loaded ${rows.length} saved records from previous session.); if (payload.last_updated) setLastUpdated(payload.last_updated); } } catch (err) { // no data yet // console.warn('No saved data yet — upload a file to start.'); } };

fetchLatest(true);
const interval = setInterval(() => fetchLatest(false), 10000);
return () => clearInterval(interval);

}, []);

const handleFileChange = (e) => setFile(e.target.files[0]);

const uploadFile = async () => { if (!file) return toast.warn('Please select an Excel or CSV file first.'); setLoading(true); try { const formData = new FormData(); formData.append('file', file); const res = await axios.post('http://localhost:8000/daily_sheet/upload', formData, { headers: { 'Content-Type': 'multipart/form-data' } }); const payload = res.data || {}; const rows = payload.items || []; setItems(rows); setSummary(payload.summary || {}); toast.success(Uploaded successfully. ${rows.length} records found.); } catch (err) { console.error(err); toast.error('Upload failed. Please check the backend or file format.'); } finally { setLoading(false); } };

const safeItems = Array.isArray(items) ? items : [];

const analytics = useMemo(() => { const active = safeItems.filter(r => r.active_now).length; const countries = [...new Set(safeItems.map(r => r.from_country).filter(Boolean))]; const legTypes = [...new Set(safeItems.map(r => r.leg_type).filter(Boolean))]; const durations = safeItems.map(r => { if (!r.begin_dt || !r.end_dt) return 0; const start = new Date(r.begin_dt); const end = new Date(r.end_dt); return Math.max(0, (end - start) / (1000 * 60 * 60 * 24)); }).filter(d => d > 0); const avgDuration = durations.length > 0 ? durations.reduce((a, b) => a + b, 0) / durations.length : 0; return { active, totalCountries: countries.length, totalTypes: legTypes.length, avgDuration: avgDuration.toFixed(1), totalTravelers: safeItems.length }; }, [safeItems]);

const countryStats = useMemo(() => { const map = {}; safeItems.forEach(r => { const c = r.from_country || 'Unknown'; if (!map[c]) map[c] = { count: 0, active: 0, travelers: new Set() }; map[c].count++; if (r.active_now) map[c].active++; map[c].travelers.add(${r.first_name} ${r.last_name}); }); return Object.entries(map).map(([country, data]) => ({ country, count: data.count, active: data.active, travelerCount: data.travelers.size })).sort((a, b) => b.count - a.count); }, [safeItems]);

const travelTypeStats = useMemo(() => { const map = {}; safeItems.forEach(r => { const type = r.leg_type || 'Unknown'; if (!map[type]) map[type] = { count: 0, active: 0, countries: new Set() }; map[type].count++; if (r.active_now) map[type].active++; if (r.from_country) map[type].countries.add(r.from_country); }); return Object.entries(map).map(([type, data]) => ({ type, count: data.count, active: data.active, countryCount: data.countries.size })).sort((a, b) => b.count - a.count); }, [safeItems]);

const recentTravelers = useMemo(() => { const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7); return safeItems.filter(r => r.begin_dt && new Date(r.begin_dt) >= sevenDaysAgo).sort((a, b) => new Date(b.begin_dt) - new Date(a.begin_dt)).slice(0, 10); }, [safeItems]);

const countries = useMemo(() => [...new Set(safeItems.map(r => r.from_country).filter(Boolean))], [safeItems]); const locations = useMemo(() => [...new Set([...safeItems.map(r => r.from_location).filter(Boolean), ...safeItems.map(r => r.to_location).filter(Boolean)])].sort(), [safeItems]); const legTypes = useMemo(() => [...new Set(safeItems.map(r => r.leg_type).filter(Boolean))], [safeItems]);

const getTravelTypeIcon = (type) => { if (!type) return FiGlobe; const typeLower = type.toLowerCase(); if (typeLower.includes('car') || typeLower.includes('vehicle')) return FaCar; if (typeLower.includes('truck') || typeLower.includes('bus')) return FaTruck; if (typeLower.includes('train') || typeLower.includes('rail')) return FaTrain; if (typeLower.includes('plane') || typeLower.includes('air') || typeLower.includes('flight')) return FaPlane; if (typeLower.includes('ship') || typeLower.includes('boat') || typeLower.includes('sea')) return FaShip; if (typeLower.includes('bike') || typeLower.includes('cycle')) return FaBicycle; if (typeLower.includes('hotel')) return FaHotel; if (typeLower.includes('stop')) return BsPersonWalking; return FaLocationArrow; };

const getTravelTypeColor = (type) => { if (!type) return '#6b7280'; const typeLower = type.toLowerCase(); if (typeLower.includes('car') || typeLower.includes('vehicle')) return '#dc2626'; if (typeLower.includes('truck') || typeLower.includes('bus')) return '#ea580c'; if (typeLower.includes('train') || typeLower.includes('rail')) return '#16a34a'; if (typeLower.includes('plane') || typeLower.includes('air') || typeLower.includes('flight')) return '#2563eb'; if (typeLower.includes('ship') || typeLower.includes('boat') || typeLower.includes('sea')) return '#7c3aed'; if (typeLower.includes('bike') || typeLower.includes('cycle')) return '#ca8a04'; return '#2465c1ff'; };

const today = new Date(); today.setHours(0, 0, 0, 0); const todayTravelers = safeItems.filter(r => { if (!r.begin_dt) return false; const start = new Date(r.begin_dt); start.setHours(0, 0, 0, 0); return start.getTime() === today.getTime(); });

const filtered = safeItems.filter(r => { const s = (filters.search || '').toLowerCase(); if (s) { const hay = ${r.first_name ?? ''} ${r.last_name ?? ''} ${r.email ?? ''} ${r.from_location ?? ''} ${r.to_location ?? ''}.toLowerCase(); if (!hay.includes(s)) return false; } if (filters.country && r.from_country !== filters.country) return false; if (filters.location) { const fromLocationMatch = r.from_location && r.from_location.toLowerCase().includes(filters.location.toLowerCase()); const toLocationMatch = r.to_location && r.to_location.toLowerCase().includes(filters.location.toLowerCase()); if (!fromLocationMatch && !toLocationMatch) return false; } if (filters.legType && r.leg_type !== filters.legType) return false; if (filters.status === 'active' && !r.active_now) return false; if (filters.status === 'inactive' && r.active_now) return false; return true; }).sort((a, b) => (b.active_now === true) - (a.active_now === true));

const exportCsv = () => { if (!filtered.length) return toast.info('No data to export.'); const keys = Object.keys(filtered[0]); const csv = [keys.join(',')]; filtered.forEach(r => csv.push(keys.map(k => "${String(r[k] ?? '').replace(/"/g, '""')}").join(','))); const blob = new Blob([csv.join('\n')], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'EmployeeTravelData.csv'; a.click(); URL.revokeObjectURL(url); toast.success('CSV exported successfully.'); };

useEffect(() => { const fetchRegionsData = async () => { if (safeItems.length > 0) { try { const response = await axios.get('http://localhost:8000/daily_sheet/regions'); setRegionsData(response.data.regions || {}); } catch (error) { console.error('Error fetching regions data:', error); } } }; fetchRegionsData(); }, [safeItems]);

const fetchRegionDetails = async (regionCode) => { try { const response = await axios.get(http://localhost:8000/daily_sheet/regions/${regionCode}); setRegionDetails(response.data.region || null); setSelectedRegion(regionCode); } catch (error) { console.error('Error fetching region details:', error); toast.error('Failed to load region details'); } };

// Traveler detail popup const TravelerDetailPopup = ({ traveler, onClose }) => { if (!traveler) return null; const TravelTypeIcon = getTravelTypeIcon(traveler.leg_type); const travelTypeColor = getTravelTypeColor(traveler.leg_type); const getDuration = () => { if (!traveler.begin_dt || !traveler.end_dt) return 'Unknown'; const start = new Date(traveler.begin_dt); const end = new Date(traveler.end_dt); const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)); return ${days} day${days !== 1 ? 's' : ''}; }; return ( <div style={styles.popupOverlay} onClick={onClose}> <div style={styles.popupContent} onClick={e => e.stopPropagation()}> <div style={styles.popupHeader}> <div style={styles.avatarLarge}><FiUser size={24} /></div> <div> <h3 style={styles.popupTitle}>{traveler.first_name} {traveler.last_name}</h3> <div style={{ color: '#6b7280' }}>Employee ID: {traveler.emp_id || 'N/A'}</div> </div> </div> <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}> <div> <strong>Trip</strong> <div style={{ marginTop: 8 }}>{traveler.from_location || 'N/A'} → {traveler.to_location || 'N/A'}</div> <div style={{ marginTop: 8 }}><strong>From Country:</strong> {traveler.from_country || 'Unknown'}</div> <div style={{ marginTop: 8 }}><strong>To Country:</strong> {traveler.to_country || 'Unknown'}</div> </div> <div> <strong>Timing</strong> <div style={{ marginTop: 8 }}><FiCalendar /> {fmt(traveler.begin_dt)}</div> <div style={{ marginTop: 8 }}><FiCalendar /> {fmt(traveler.end_dt)}</div> <div style={{ marginTop: 8 }}><strong>Duration:</strong> {getDuration()}</div> </div> </div> <div style={{ marginTop: 12, display: 'flex', justifyContent: 'flex-end', gap: 8 }}> <button onClick={onClose} style={{ padding: '8px 12px', borderRadius: 8 }}>Close</button> </div> </div> </div> ); };

return ( <div style={styles.page}> <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}> <h2>Employee Travel Dashboard</h2> <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}> <button onClick={toggleTheme} style={{ padding: 8, borderRadius: 8 }}>{isDarkTheme ? 'Light' : 'Dark'}</button> <button onClick={() => { if (window.confirm('Clear all daily travel records?')) axios.delete('http://localhost:8000/daily_sheet/clear').then(() => { setItems([]); setSummary({}); toast.success('Daily travel cleared'); }).catch(() => toast.error('Failed')); }} style={{ padding: 8, borderRadius: 8 }}>Clear Daily</button> </div> </div>

<div style={styles.card}>
    <div style={styles.compactUploadRow}>
      <div style={styles.compactFileUpload}>
        <input id="file-upload" type="file" accept=".xlsx,.xls,.csv" onChange={handleFileChange} style={styles.fileInput} />
        <label htmlFor="file-upload" style={styles.compactFileLabel}><FiUpload /> {file ? file.name : 'Choose File'}</label>
      </div>
      <div style={{ display: 'flex', gap: 8 }}>
        <button onClick={uploadFile} disabled={loading} style={loading ? { ...styles.compactPrimaryBtn, opacity: 0.6 }