[nodemon] starting `node src/server.js`
‚úÖ MSSQL connected
üöÄ Server running on port 3001
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')
    at exports.fetchLiveOccupancy (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\services\occupancy.service.js:110:29)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
    at async exports.getLiveSummary (C:\Users\W0024618\Desktop\laca-occupancy-backend\src\controllers\occupancy.controller.js:69:20)
TypeError: Cannot read properties of undefined (reading 'request')




// C:\Users\W0024618\Desktop\laca-occupancy-backend\src\config\db.js
const sql = require('mssql');
require('dotenv').config();

const dbConfig = {
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  server: process.env.DB_SERVER,
  database: process.env.DB_DATABASE,
  port: parseInt(process.env.DB_PORT, 10),
  pool: {
    max: 10,
    min: 0,
    idleTimeoutMillis: 30000,
  },
  options: {
    encrypt: true,
    trustServerCertificate: true, // dev only
    enableArithAbort: true,
  },
};

let pool; // shared connection pool instance

// connect with automatic retry logic
async function getConnection() {
  try {
    if (pool) {
      // check if pool is still connected
      if (pool.connected) return pool;
      if (pool.connecting) {
        await pool.connecting;
        return pool;
      }
    }

    pool = new sql.ConnectionPool(dbConfig);

    // set up event listeners for connection issues
    pool.on('error', (err) => {
      console.error('‚ùå SQL pool error', err);
      if (err.code === 'ESOCKET' || err.code === 'ECONNRESET') {
        console.log('üîÅ Attempting to reconnect to SQL Server...');
        reconnect();
      }
    });

    await pool.connect();
    console.log('‚úÖ MSSQL connected');
    return pool;
  } catch (err) {
    console.error('‚ùå MSSQL initial connection failed:', err);
    await new Promise((resolve) => setTimeout(resolve, 5000));
    console.log('üîÅ Retrying MSSQL connection...');
    return getConnection(); // recursive retry
  }
}

// reconnect helper
async function reconnect() {
  try {
    await sql.close();
  } catch (e) {
    // ignore
  }
  pool = null;
  await getConnection();
}

// safe query helper
async function query(queryText, params = {}) {
  const conn = await getConnection();
  const request = conn.request();
  for (const [key, value] of Object.entries(params)) {
    request.input(key, value);
  }
  return request.query(queryText);
}

module.exports = {
  sql,
  getConnection,
  query,
};
