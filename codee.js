why show this UNKNOWN regin 

"UNKNOWN": {
      "region_code": "UNKNOWN",
      "total_count": 39,
      "active_count": 0,
      "cities": {
        "Miami": {
          "city_name": "Miami",
          "total_count": 8,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "MANUEL",
              "last_name": "BUSTILLO MORAN",
              "email": "manuel.bustillo@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "MANUEL",
              "last_name": "BUSTILLO MORAN",
              "email": "manuel.bustillo@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "SCOTT",
              "last_name": "FREEMAN",
              "email": "scott.freeman@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "ERICH",
              "last_name": "JANZEN",
              "email": "erich.janzen@wu.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "ERICH",
              "last_name": "JANZEN",
              "email": "erich.janzen@wu.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "ERICH",
              "last_name": "JANZEN",
              "email": "erich.janzen@wu.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "MARK",
              "last_name": "SERES",
              "email": "mark.seres@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "MARK",
              "last_name": "SERES",
              "email": "mark.seres@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Washington D.C.": {
          "city_name": "Washington D.C.",
          "total_count": 6,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "ARI",
              "last_name": "HAGNAS",
              "email": "ari.hagnas@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "ARI",
              "last_name": "HAGNAS",
              "email": "ari.hagnas@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "JAMAL",
              "last_name": "KHALAF",
              "email": "jim.khalaf@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "JAMAL",
              "last_name": "KHALAF",
              "email": "jim.khalaf@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "RYAN",
              "last_name": "SPETOSKEY",
              "email": "ryan.spetoskey@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "SCOTT",
              "last_name": "TOWERS",
              "email": "scott.towers@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Shenzhen": {
          "city_name": "Shenzhen",
          "total_count": 3,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "VIVEK",
              "last_name": "SINGH",
              "email": "vivek.singh@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "DANNY",
              "last_name": "BEH",
              "email": "danny.beh@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "VINCE",
              "last_name": "TALLENT",
              "email": "vince.tallent@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Las Vegas": {
          "city_name": "Las Vegas",
          "total_count": 3,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "AMANDA",
              "last_name": "DEMAREST",
              "email": "amanda.demarest@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "AMANDA",
              "last_name": "DEMAREST",
              "email": "amanda.demarest@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "AMANDA",
              "last_name": "DEMAREST",
              "email": "amanda.demarest@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Saint Louis": {
          "city_name": "Saint Louis",
          "total_count": 3,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "STEPHANIE",
              "last_name": "HOWARD",
              "email": "stephanie.howard@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "STEPHANIE",
              "last_name": "HOWARD",
              "email": "stephanie.howard@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "STEPHANIE",
              "last_name": "HOWARD",
              "email": "stephanie.howard@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Baltimore": {
          "city_name": "Baltimore",
          "total_count": 2,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "SCOTT",
              "last_name": "TOWERS",
              "email": "scott.towers@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "SCOTT",
              "last_name": "TOWERS",
              "email": "scott.towers@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Oakland": {
          "city_name": "Oakland",
          "total_count": 2,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "ADAM",
              "last_name": "WYNNE",
              "email": "adam.wynne@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            },
            {
              "first_name": "ADAM",
              "last_name": "WYNNE",
              "email": "adam.wynne@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "CÃ³rdoba": {
          "city_name": "CÃ³rdoba",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "LEONARDO",
              "last_name": "BLANQUER",
              "email": "leonardo.blanquer@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Salta": {
          "city_name": "Salta",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "MATIAS",
              "last_name": "MATTA",
              "email": "matias.matta@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Graz": {
          "city_name": "Graz",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "ABDULHAMIT",
              "last_name": "AKYILMAZ",
              "email": "abdulhamit.akyilmaz@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Zaragoza": {
          "city_name": "Zaragoza",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "JAVIER",
              "last_name": "FLORIDO LOZANO",
              "email": "javieralexander.floridolozano@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Barcelona": {
          "city_name": "Barcelona",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "JORGE",
              "last_name": "GOMEZ GONZALEZ",
              "email": "jorge.gonzalez@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Perpignan": {
          "city_name": "Perpignan",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "YOANN",
              "last_name": "VELLA",
              "email": "yoann.vella@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Ancona": {
          "city_name": "Ancona",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "DAN",
              "last_name": "PANOV",
              "email": "dan.panov@wu.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Ho Chi Minh City": {
          "city_name": "Ho Chi Minh City",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "ATISH",
              "last_name": "SHRESTHA",
              "email": "atish.shrestha@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Doncaster": {
          "city_name": "Doncaster",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "SANTOK",
              "last_name": "THAPER",
              "email": "santok.thaper@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Fort Lauderdale": {
          "city_name": "Fort Lauderdale",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "SCOTT",
              "last_name": "FREEMAN",
              "email": "scott.freeman@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Luton": {
          "city_name": "Luton",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "JANICE",
              "last_name": "PIACENTE",
              "email": "janice.piacente@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        },
        "Annapolis": {
          "city_name": "Annapolis",
          "total_count": 1,
          "active_count": 0,
          "sample_items": [
            {
              "first_name": "SCOTT",
              "last_name": "TOWERS",
              "email": "scott.towers@westernunion.com",
              "pnr": null,
              "active_now": 0,
              "begin_dt": null,
              "end_dt": null
            }
          ]
        }
      }
    },

# ðŸŒ Region mapping (includes common cities, states, and countries)
COUNTRY_TO_REGION = {
    # ---------------- APAC ----------------
    'india': 'APAC', 'pune': 'APAC', 'mumbai': 'APAC', 'hyderabad': 'APAC', 'chennai': 'APAC',
    'bangalore': 'APAC', 'delhi': 'APAC', 'gurgaon': 'APAC', 'quezon city': 'APAC',
    'taguig city': 'APAC', 'manila': 'APAC', 'philippines': 'APAC',
    'china': 'APAC', 'shanghai': 'APAC', 'beijing': 'APAC', 'hong kong': 'APAC',
    'japan': 'APAC', 'tokyo': 'APAC', 'osaka': 'APAC',
    'australia': 'APAC', 'sydney': 'APAC', 'melbourne': 'APAC', 'hobart': 'APAC',
    'singapore': 'APAC', 'singapore city': 'APAC',
    'malaysia': 'APAC', 'kuala lumpur': 'APAC',
    'indonesia': 'APAC', 'jakarta': 'APAC', 'bali': 'APAC',
    'thailand': 'APAC', 'bangkok': 'APAC',
    'vietnam': 'APAC', 'hanoi': 'APAC',
    'south korea': 'APAC', 'seoul': 'APAC',
    'pakistan': 'APAC', 'karachi': 'APAC',
    'bangladesh': 'APAC', 'dhaka': 'APAC',
    'new zealand': 'APAC', 'auckland': 'APAC',

    # ---------------- NAMER ----------------
    'united states': 'NAMER', 'usa': 'NAMER', 'us': 'NAMER',
    'new york': 'NAMER', 'los angeles': 'NAMER', 'houston': 'NAMER', 'denver': 'NAMER',
    'boston': 'NAMER', 'atlanta': 'NAMER', 'newark': 'NAMER',
    'canada': 'NAMER', 'toronto': 'NAMER', 'vancouver': 'NAMER', 'montreal': 'NAMER', 'regina': 'NAMER',
    'mexico': 'NAMER', 'mexico city': 'NAMER',

    # ---------------- LACA ----------------
    'brazil': 'LACA', 'sÃ£o paulo': 'LACA', 'rio de janeiro': 'LACA',
    'argentina': 'LACA', 'buenos aires': 'LACA',
    'chile': 'LACA', 'santiago': 'LACA',
    'colombia': 'LACA', 'bogotÃ¡': 'LACA',
    'peru': 'LACA', 'lima': 'LACA',
    'venezuela': 'LACA', 'caracas': 'LACA',
    'panama': 'LACA', 'panama city': 'LACA',
    'costa rica': 'LACA', 'san josÃ©': 'LACA', 'san jose': 'LACA',
    'guatemala': 'LACA', 'guatemala city': 'LACA',
    'paraguay': 'LACA', 'asunciÃ³n': 'LACA', 'asuncion': 'LACA',
    'uruguay': 'LACA', 'montevideo': 'LACA',
    'ecuador': 'LACA', 'quito': 'LACA',

    # ---------------- EMEA ----------------
    'united kingdom': 'EMEA', 'uk': 'EMEA', 'london': 'EMEA', 'manchester': 'EMEA',
    'ireland': 'EMEA', 'dublin': 'EMEA', 'cork': 'EMEA',
    'spain': 'EMEA', 'madrid': 'EMEA', 'valencia': 'EMEA', 'bilbao': 'EMEA',
    'palma de mallorca': 'EMEA', 'ibiza': 'EMEA',
    'italy': 'EMEA', 'rome': 'EMEA', 'milan': 'EMEA', 'trieste': 'EMEA',
    'france': 'EMEA', 'paris': 'EMEA',
    'germany': 'EMEA', 'berlin': 'EMEA', 'munich': 'EMEA', 'frankfurt': 'EMEA',
    'austria': 'EMEA', 'vienna': 'EMEA',
    'lithuania': 'EMEA', 'vilnius': 'EMEA',
    'romania': 'EMEA', 'oradea': 'EMEA', 'bucharest': 'EMEA',
    'greece': 'EMEA', 'athens': 'EMEA',
    'portugal': 'EMEA', 'lisbon': 'EMEA',
    'russia': 'EMEA', 'moscow': 'EMEA',
    'uae': 'EMEA', 'abu dhabi': 'EMEA', 'dubai': 'EMEA',
    'morocco': 'EMEA', 'casablanca': 'EMEA',
    'netherlands': 'EMEA', 'amsterdam': 'EMEA',
    'poland': 'EMEA', 'warsaw': 'EMEA',
    'saudi arabia': 'EMEA', 'riyadh': 'EMEA',
    'south africa': 'EMEA', 'johannesburg': 'EMEA',
    'egypt': 'EMEA', 'cairo': 'EMEA',
}

DEFAULT_REGION = 'UNKNOWN'


def guess_region(country: Optional[str], location: Optional[str]) -> str:
    """Guess a region using either country or location (case-insensitive, fuzzy matching)."""
    text_parts = []
    if country: text_parts.append(str(country).lower())
    if location: text_parts.append(str(location).lower())
    combined = " ".join(text_parts)

    for key, region in COUNTRY_TO_REGION.items():
        if key in combined:
            return region
    return DEFAULT_REGION



def normalize_city(location: Optional[str]) -> Optional[str]:
    """Simplify city name for grouping."""
    if not location:
        return None
    s = str(location).strip().split(',')[0]
    return s.title()


def build_regions_summary(items: list) -> dict:
    """Group all items by region -> city, with counts and sample travelers."""
    regions = {}
    for it in items:
        country = it.get('to_country') or it.get('from_country')
        location = it.get('to_location') or it.get('from_location')
        region = guess_region(country, location)
        city = normalize_city(location) or "Unknown"

        if region not in regions:
            regions[region] = {
                "region_code": region,
                "total_count": 0,
                "active_count": 0,
                "cities": {}
            }

        regions[region]["total_count"] += 1
        if it.get("active_now"):
            regions[region]["active_count"] += 1

        cities = regions[region]["cities"]
        if city not in cities:
            cities[city] = {
                "city_name": city,
                "total_count": 0,
                "active_count": 0,
                "sample_items": []
            }

        cities[city]["total_count"] += 1
        if it.get("active_now"):
            cities[city]["active_count"] += 1

        if len(cities[city]["sample_items"]) < 10:
            cities[city]["sample_items"].append({
                "first_name": it.get("first_name"),
                "last_name": it.get("last_name"),
                "email": it.get("email"),
                "pnr": it.get("pnr"),
                "active_now": it.get("active_now"),
                "begin_dt": it.get("begin_dt"),
                "end_dt": it.get("end_dt")
            })

    # Sort by descending counts
    for reg_data in regions.values():
        reg_data["cities"] = dict(
            sorted(reg_data["cities"].items(), key=lambda kv: -kv[1]["total_count"])
        )

    return regions

@router.get("/regions")
def get_regions():
    """
    Return regional travel summary grouped by region (APAC, EMEA, NAMER, LACA, UNKNOWN).
    Uses memory cache if available, else loads from DB.
    """

    # 1ï¸âƒ£ Try using memory first
    if previous_data.get("items"):
        items = previous_data["items"]
    else:
        # 2ï¸âƒ£ Fallback to DB
        db = SessionLocal()
        rows = db.query(DailyTravel).all()
        db.close()
        if not rows:
            raise HTTPException(status_code=404, detail="No travel data available in memory or database.")
        items = [{k: v for k, v in r.__dict__.items() if k != "_sa_instance_state"} for r in rows]
        previous_data["items"] = items

    # 3ï¸âƒ£ Use the region builder you defined earlier
    regions = build_regions_summary(items)

    # 4ï¸âƒ£ Cache + timestamp
    previous_data["regions_summary"] = regions
    previous_data["last_updated"] = datetime.now().isoformat()

    # 5ï¸âƒ£ Return the summary
    return JSONResponse(content={
        "regions": regions,
        "last_updated": previous_data["last_updated"],
        "message": "Loaded region summary from memory or database"
    })
