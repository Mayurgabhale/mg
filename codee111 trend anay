{modalRow &&
  <div className="modal" onClick={closeModal}>
    <div className="modal-inner" onClick={function (e) { e.stopPropagation(); }}>
      {/* Professional Header */}
      <div className="modal-header">
        <div className="header-main">
          <i className="bi bi-clipboard2-data"></i>
          <div>
            <h3>Details — Evidence</h3>
            <p>Employee activity analysis and supporting documentation</p>
          </div>
        </div>
        <button className="close-btn" onClick={closeModal}>
          <i className="bi bi-x-lg"></i>
        </button>
      </div>

      <div className="modal-body">
        {modalLoading && (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <span>Loading evidence…</span>
          </div>
        )}

        {/* Main Content Grid */}
        <div className="content-grid">
          {/* Employee Profile Section */}
          <div className="profile-section">
            <div className="profile-image">
              <div className="image-frame">
                {(modalDetails && modalDetails.aggregated_rows && modalDetails.aggregated_rows.length > 0) ? (
                  (() => {
                    const md = modalDetails.aggregated_rows[0];
                    if (md && md.imageUrl) {
                      return (
                        <img 
                          className="employee-photo" 
                          src={API_BASE + md.imageUrl} 
                          alt="Employee" 
                          onError={(e) => { 
                            e.target.style.display = 'none'; 
                            e.target.nextSibling.style.display = 'flex';
                          }} 
                        />
                      );
                    } else {
                      return <div className="image-placeholder">No image available</div>;
                    }
                  })()
                ) : (
                  <div className="image-placeholder">
                    <i className="bi bi-person"></i>
                  </div>
                )}
              </div>
            </div>
            
            <div className="employee-info">
              <h2>{sanitizeName(modalRow) || "—"}</h2>
              <div className="employee-id">ID: {modalRow.EmployeeID || "—"}</div>
              
              <div className="info-grid">
                <div className="info-item">
                  <i className="bi bi-credit-card"></i>
                  <div>
                    <label>Card Number</label>
                    <span>{modalRow.CardNumber || "—"}</span>
                  </div>
                </div>
                
                <div className="info-item">
                  <i className="bi bi-envelope"></i>
                  <div>
                    <label>Email</label>
                    <span>{(modalDetails && modalDetails.aggregated_rows && modalDetails.aggregated_rows[0] && modalDetails.aggregated_rows[0].EmployeeEmail) ? 
                      modalDetails.aggregated_rows[0].EmployeeEmail : "—"}</span>
                  </div>
                </div>
                
                <div className="info-item">
                  <i className="bi bi-calendar"></i>
                  <div>
                    <label>Date</label>
                    <span>{safeDateDisplay(modalRow.Date || modalRow.FirstSwipe)}</span>
                  </div>
                </div>
                
                <div className="info-item">
                  <i className="bi bi-clock"></i>
                  <div>
                    <label>Duration</label>
                    <span className="duration">{modalRow.Duration || (modalRow.DurationMinutes ? Math.round(modalRow.DurationMinutes) + " min" : "—")}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Analysis Section */}
          <div className="analysis-section">
            <div className="analysis-card">
              <div className="card-header">
                <i className="bi bi-flag"></i>
                <h4>Flag Analysis</h4>
              </div>
              
              <div className="reasons-section">
                <h5>Reasons Flagged</h5>
                <div className="reasons-list">
                  {renderReasonChips(modalRow.Reasons)}
                </div>
              </div>

              <div className="explanation-section">
                <h5>Analysis Details</h5>
                <div className="explanation-box">
                  {renderReasonExplanations(modalRow.Reasons)}
                </div>
              </div>
            </div>
          </div>

          {/* Evidence Files Section */}
          <div className="files-section">
            <div className="files-card">
              <div className="card-header">
                <i className="bi bi-files"></i>
                <h4>Evidence Files</h4>
              </div>
              
              <div className="files-content">
                {modalDetails && modalDetails.raw_swipe_files && modalDetails.raw_swipe_files.length > 0 ? (
                  <div className="files-grid">
                    {modalDetails.raw_swipe_files.map((f, i) => (
                      <div key={i} className="file-card">
                        <i className="bi bi-file-earmark-text"></i>
                        <div className="file-info">
                          <span className="file-name">{f}</span>
                          <button 
                            className="download-btn"
                            onClick={function () { window.location = API_BASE + "/swipes/" + encodeURIComponent(f); }}
                          >
                            <i className="bi bi-download"></i>
                            Download
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="no-files">
                    <i className="bi bi-folder-x"></i>
                    <span>No evidence files available</span>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Timeline Section */}
          <div className="timeline-section">
            <div className="timeline-card">
              <div className="card-header">
                <i className="bi bi-clock-history"></i>
                <h4>Swipe Timeline</h4>
              </div>
              <div className="timeline-content">
                {modalDetails ? renderSwipeTimeline(modalDetails, modalRow) : (
                  <div className="no-timeline">
                    <i className="bi bi-hourglass"></i>
                    <span>Timeline data loading...</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>

        {/* Raw Data Toggle */}
        <div className="raw-data-section">
          <label className="raw-toggle">
            <input 
              type="checkbox" 
              id="showraw" 
              onChange={function (e) {
                const el = document.getElementById('rawpayload');
                if (el) el.style.display = e.target.checked ? 'block' : 'none';
              }} 
            />
            <span className="toggle-label">
              <i className="bi bi-code-slash"></i>
              Show raw data
            </span>
          </label>
          <div id="rawpayload" className="raw-data">
            <pre>{JSON.stringify(modalRow, null, 2)}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
}







/* ---------- Professional Evidence Modal Styles ---------- */
.modal {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  background: rgba(0, 0, 0, 0.5);
  padding: 20px;
}

.modal-inner {
  width: 1200px;
  max-width: 95vw;
  height: 90vh;
  max-height: 800px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Professional Header */
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: white;
  border-bottom: 1px solid #e5e7eb;
}

.header-main {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-main i {
  font-size: 24px;
  color: #374151;
  background: #f3f4f6;
  padding: 8px;
  border-radius: 8px;
}

.header-main h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #111827;
}

.header-main p {
  margin: 2px 0 0 0;
  font-size: 13px;
  color: #6b7280;
}

.close-btn {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 6px;
  color: #6b7280;
  cursor: pointer;
  transition: all 0.2s;
}

.close-btn:hover {
  background: #f3f4f6;
  color: #374151;
}

/* Modal Body */
.modal-body {
  flex: 1;
  padding: 0;
  overflow: auto;
  background: #f9fafb;
}

/* Loading State */
.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 60px 20px;
  color: #6b7280;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #374151;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Main Content Grid */
.content-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto;
  gap: 20px;
  padding: 24px;
  max-width: 100%;
  box-sizing: border-box;
}

/* Profile Section */
.profile-section {
  grid-column: 1;
  grid-row: 1;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 20px;
}

.profile-image {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.image-frame {
  width: 140px;
  height: 140px;
  border-radius: 8px;
  overflow: hidden;
  border: 3px solid #f3f4f6;
  background: #f9fafb;
}

.employee-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f3f4f6;
  color: #9ca3af;
}

.image-placeholder i {
  font-size: 40px;
}

.employee-info h2 {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  text-align: center;
}

.employee-id {
  text-align: center;
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 20px;
  background: #f3f4f6;
  padding: 4px 12px;
  border-radius: 20px;
  display: inline-block;
}

.info-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.info-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.info-item i {
  color: #374151;
  font-size: 16px;
  width: 20px;
}

.info-item label {
  display: block;
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  margin-bottom: 2px;
}

.info-item span {
  display: block;
  font-size: 14px;
  color: #111827;
  font-weight: 500;
}

.duration {
  background: #10b981;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

/* Analysis Section */
.analysis-section {
  grid-column: 2;
  grid-row: 1;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 20px;
}

.analysis-card {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e5e7eb;
}

.card-header i {
  color: #ef4444;
  font-size: 18px;
}

.card-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #111827;
}

.reasons-section,
.explanation-section {
  margin-bottom: 20px;
}

.reasons-section h5,
.explanation-section h5 {
  margin: 0 0 12px 0;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

.reasons-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 80px;
  overflow-y: auto;
}

.explanation-box {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 16px;
  max-height: 120px;
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.5;
  color: #374151;
}

/* Files Section */
.files-section {
  grid-column: 1;
  grid-row: 2;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 20px;
}

.files-card {
  height: 100%;
}

.files-content {
  max-height: 200px;
  overflow-y: auto;
}

.files-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.file-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.file-card i {
  color: #374151;
  font-size: 18px;
}

.file-info {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.file-name {
  font-size: 13px;
  font-weight: 500;
  color: #374151;
}

.download-btn {
  background: #374151;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: background 0.2s;
}

.download-btn:hover {
  background: #4b5563;
}

.no-files {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
  padding: 40px 20px;
  color: #9ca3af;
}

/* Timeline Section */
.timeline-section {
  grid-column: 2;
  grid-row: 2;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 20px;
}

.timeline-content {
  max-height: 200px;
  overflow-y: auto;
}

.no-timeline {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
  padding: 40px 20px;
  color: #9ca3af;
}

/* Raw Data Section */
.raw-data-section {
  grid-column: 1 / -1;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 20px;
  margin-top: 0;
}

.raw-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 14px;
  color: #374151;
  font-weight: 500;
}

.raw-toggle input {
  margin: 0;
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 6px;
}

.raw-data {
  display: none;
  margin-top: 16px;
  background: #1f2937;
  color: #e5e7eb;
  padding: 16px;
  border-radius: 6px;
  overflow: auto;
  max-height: 200px;
  font-size: 12px;
  font-family: 'Monaco', 'Consolas', monospace;
}

/* Hide scrollbars */
.reasons-list,
.explanation-box,
.files-content,
.timeline-content,
.raw-data {
  scrollbar-width: thin;
  scrollbar-color: #d1d5db #f3f4f6;
}

.reasons-list::-webkit-scrollbar,
.explanation-box::-webkit-scrollbar,
.files-content::-webkit-scrollbar,
.timeline-content::-webkit-scrollbar,
.raw-data::-webkit-scrollbar {
  width: 6px;
}

.reasons-list::-webkit-scrollbar-track,
.explanation-box::-webkit-scrollbar-track,
.files-content::-webkit-scrollbar-track,
.timeline-content::-webkit-scrollbar-track,
.raw-data::-webkit-scrollbar-track {
  background: #f3f4f6;
  border-radius: 3px;
}

.reasons-list::-webkit-scrollbar-thumb,
.explanation-box::-webkit-scrollbar-thumb,
.files-content::-webkit-scrollbar-thumb,
.timeline-content::-webkit-scrollbar-thumb,
.raw-data::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .content-grid {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
  
  .profile-section { grid-column: 1; grid-row: 1; }
  .analysis-section { grid-column: 1; grid-row: 2; }
  .files-section { grid-column: 1; grid-row: 3; }
  .timeline-section { grid-column: 1; grid-row: 4; }
  .raw-data-section { grid-column: 1; grid-row: 5; }
}

@media (max-width: 768px) {
  .modal-inner {
    max-width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .content-grid {
    padding: 16px;
    gap: 16px;
  }
  
  .profile-section,
  .analysis-section,
  .files-section,
  .timeline-section,
  .raw-data-section {
    padding: 16px;
  }
}