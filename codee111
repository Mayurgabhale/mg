const query = `
  WITH CombinedQuery AS (
    SELECT
      DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) AS LocaleMessageTime,
      t1.ObjectName1,
      t1.ObjectName2            AS Door,
      CASE
        WHEN t3.Name IN ('Contractor','Terminated Contractor')
          THEN t2.Text12
        ELSE CAST(t2.Int1 AS NVARCHAR)
      END                       AS EmployeeID,
      t2.text5                  AS Text5,
      t1.PartitionName2         AS PartitionName2,
      t1.ObjectIdentity1        AS PersonGUID,
      t3.Name                   AS PersonnelType,
      t2.Text4                   AS CompanyName,   -- ✅ company
      t2.Text5                   AS PrimaryLocation, -- ✅ location
      COALESCE(
        TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID/Card)[1]','varchar(50)'),
        TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID)[1]','varchar(50)'),
        sc.value
      )                         AS CardNumber,
      t5a.value                 AS AdmitCode,
      t5d.value                 AS Direction
    FROM [ACVSUJournal_00011029].[dbo].[ACVSUJournalLog] AS t1
    LEFT JOIN [ACVSCore].[Access].[Personnel]     AS t2
      ON t1.ObjectIdentity1 = t2.GUID
    LEFT JOIN [ACVSCore].[Access].[PersonnelType] AS t3
      ON t2.PersonnelTypeId = t3.ObjectID
    LEFT JOIN [ACVSUJournal_00011029].[dbo].[ACVSUJournalLogxmlShred] AS t5a
      ON t1.XmlGUID = t5a.GUID AND t5a.Name = 'AdmitCode'
    LEFT JOIN [ACVSUJournal_00011029].[dbo].[ACVSUJournalLogxmlShred] AS t5d
      ON t1.XmlGUID = t5d.GUID AND t5d.Value IN ('InDirection','OutDirection')
    LEFT JOIN [ACVSUJournal_00011029].[dbo].[ACVSUJournalLogxml] AS t_xml
      ON t1.XmlGUID = t_xml.GUID
    LEFT JOIN (
      SELECT GUID, value
      FROM [ACVSUJournal_00011029].[dbo].[ACVSUJournalLogxmlShred]
      WHERE Name IN ('Card','CHUID')
    ) AS sc
      ON t1.XmlGUID = sc.GUID
    WHERE
      t1.MessageType = 'CardAdmitted'
      AND t1.PartitionName2 IN (${partitionsSql})
      AND DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) >= DATEADD(HOUR, -48, GETDATE())
  )
  SELECT
    LocaleMessageTime,
    CONVERT(VARCHAR(10), LocaleMessageTime, 23) AS Dateonly,
    CONVERT(VARCHAR(8), LocaleMessageTime, 108) AS Swipe_Time,
    EmployeeID,
    PersonGUID,
    ObjectName1,
    Door,
    PersonnelType,
    CardNumber,
    Text5,
    PartitionName2,
    AdmitCode,
    Direction,
    CompanyName,
    PrimaryLocation
  FROM CombinedQuery
  ORDER BY LocaleMessageTime ASC;
`;